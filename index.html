<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Web Player</title>
    <style>
        #controls {
            margin-top: 20px;
        }
        #controls button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Spotify Web Player</h1>
    <button onclick="login()">Login with Spotify</button>
    <div id="player"></div>
    <div id="controls">
        <button onclick="play()">Play</button>
        <button onclick="pause()">Pause</button>
        <button onclick="previous()">Previous</button>
        <button onclick="next()">Next</button>
    </div>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        const CLIENT_ID = 'a9634d40010e400c9a8f2a3f5969f9a8';
        const REDIRECT_URI = 'https://joshuariewesell.github.io/drei-fragezeichen/';

        let player;
        let device_id;
        let token;

        function login() {
            const scopes = 'user-read-playback-state user-modify-playback-state user-read-currently-playing';
            const url = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${REDIRECT_URI}&scope=${encodeURIComponent(scopes)}`;
            window.location.href = url;
        }

        function getAccessToken(code) {
            return fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + btoa(CLIENT_ID + ':' + '0ee8e63a5df04c20b5f193491558f0fe')
                },
                body: new URLSearchParams({
                    grant_type: 'authorization_code',
                    code: code,
                    redirect_uri: REDIRECT_URI
                })
            }).then(response => response.json());
        }

        function setUpPlayer(access_token) {
            token = access_token;
            window.onSpotifyWebPlaybackSDKReady = () => {
                player = new Spotify.Player({
                    name: 'Web Playback SDK Quick Start Player',
                    getOAuthToken: cb => { cb(token); }
                });

                player.addListener('initialization_error', ({ message }) => { console.error(message); });
                player.addListener('authentication_error', ({ message }) => { console.error(message); });
                player.addListener('account_error', ({ message }) => { console.error(message); });
                player.addListener('playback_error', ({ message }) => { console.error(message); });

                player.addListener('player_state_changed', state => {
                    console.log(state);
                });

                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    this.device_id = device_id;
                    document.getElementById('controls').style.display = 'block';
                    playTrack(device_id, token, 'spotify:track:2M9MK7bHLtZfaoFSTcpa9s');
                });

                player.connect();
            };
        }

        function playTrack(device_id, token, track_uri) {
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [track_uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });
        }

        function play() {
            player.resume().then(() => {
                console.log('Playback resumed');
            });
        }

        function pause() {
            player.pause().then(() => {
                console.log('Playback paused');
            });
        }

        function previous() {
            player.previousTrack().then(() => {
                console.log('Skipped to previous track');
            });
        }

        function next() {
            player.nextTrack().then(() => {
                console.log('Skipped to next track');
            });
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                getAccessToken(code).then(data => {
                    const { access_token } = data;
                    setUpPlayer(access_token);
                });
            }
        };
    </script>
</body>
</html>
